name: Run nix build on repo.
run-name: ${{ gitea.actor }} builds all.
on: [push]

jobs:
  Build:
    runs-on: gitea-latest
    container:
      credentials:
        username: luca
        password: "${{ secrets.ACT_RUNNER_REGISTRY }}"
    steps:
      - uses: actions/checkout@v5
      - run: nix build
      - run: nix store sign --all --key-file /root/nix-store-key
      - run: nix copy --to 's3://dcr-nix-cache?profile=garage&scheme=https&endpoint=garage.dcr.lu&region=europe01' $(nix-store --query $(nix path-info --recursive --derivation))
